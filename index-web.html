<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>繁體農民曆 - 國慶假日修正版</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="農民曆">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap');
        
        :root {
            --iphone-safe-top: env(safe-area-inset-top);
            --iphone-safe-bottom: env(safe-area-inset-bottom);
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #fcfcfb; 
            color: #1a1a1a;
            padding-top: var(--iphone-safe-top);
            padding-bottom: var(--iphone-safe-bottom);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .serif { font-family: 'Noto Serif TC', serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        
        .day-box { 
            aspect-ratio: 1; 
            border: 0.5px solid #f3f4f6; 
            transition: transform 0.1s; 
            cursor: pointer; 
            position: relative; 
            overflow: hidden;
        }
        
        .day-box:active {
            transform: scale(0.95);
            background-color: #f3f4f6;
        }

        .active-day { border: 2.5px solid #1a1a1a !important; z-index: 20; }
        
        .festival-tag {
            background-color: #a62c2b; color: white; padding: 2px 10px; font-size: 0.75rem;
            letter-spacing: 0.1em; display: inline-block; margin-bottom: 0.5rem; border-radius: 4px;
        }

        select {
            appearance: none;
            background: transparent;
            border: none;
            padding: 0 4px;
            font-weight: bold;
            color: #1a1a1a;
            text-align: center;
        }

        #copyTip { transition: opacity 0.3s; opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="p-4">

<div class="max-w-5xl mx-auto">
    <header class="flex flex-col space-y-4 border-b border-black pb-4 mb-6">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-light tracking-[0.1em] serif">農民曆</h1>
            <button onclick="goToday()" class="bg-black text-white px-5 py-1.5 rounded-full text-xs font-bold active:opacity-70">今日</button>
        </div>
        
        <div class="flex items-center justify-between bg-gray-100 rounded-xl p-1 shadow-inner">
            <button onclick="changeMonth(-1)" class="w-12 h-10 flex items-center justify-center font-bold text-gray-400">〈</button>
            <div class="flex items-center space-x-1 text-lg">
                <select id="yearSelect" onchange="onPickerChange()"></select>
                <span class="text-gray-400 font-light">年</span>
                <select id="monthSelect" onchange="onPickerChange()">
                    <option value="0">1</option><option value="1">2</option><option value="2">3</option>
                    <option value="3">4</option><option value="4">5</option><option value="5">6</option>
                    <option value="6">7</option><option value="7">8</option><option value="8">9</option>
                    <option value="9">10</option><option value="10">11</option><option value="11">12</option>
                </select>
                <span class="text-gray-400 font-light">月</span>
            </div>
            <button onclick="changeMonth(1)" class="w-12 h-10 flex items-center justify-center font-bold text-gray-400">〉</button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="calendar-grid text-center text-xs font-bold text-gray-400 mb-2 tracking-widest">
                <div class="text-red-500 py-2">日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div class="text-red-500 py-2">六</div>
            </div>
            <div id="calendarDays" class="calendar-grid rounded-2xl overflow-hidden border border-gray-100 shadow-sm bg-gray-200"></div>
        </div>

        <div class="relative">
            <div id="detailPanel" class="bg-white p-6 rounded-3xl border border-gray-100 shadow-xl relative overflow-hidden min-h-[500px]"></div>
            <div id="copyTip" class="absolute top-4 right-4 bg-stone-800 text-white text-[10px] px-2 py-1 rounded z-50">已複製</div>
        </div>
    </div>
</div>

<script>
    // --- 國定假日判定邏輯 ---
    function getTWOHoliday(solar, lunar) {
        const sm = solar.getMonth(); // 1-12
        const sd = solar.getDay();
        const lm = lunar.getMonth(); // 1-12
        const ld = lunar.getDay();
        const year = solar.getYear();

        // 陽曆固定假日
        if (sm === 1 && sd === 1) return "元旦";
        if (sm === 2 && sd === 28) return "和平紀念日";
        if (sm === 4 && sd === 4) return "兒童節";
        if (sm === 5 && sd === 1) return "勞動節";
        if (sm === 9 && sd === 28) return "教師節";
        if (sm === 10 && sd === 10) return "國慶日";
        
        // 2025年起新增假日
        if (year >= 2025) {
            if (sm === 10 && sd === 25) return "臺灣光復節";
            if (sm === 12 && sd === 25) return "行憲紀念日";
        }

        // 農曆固定假日
        if (lm === 1 && ld === 1) return "春節";
        if (lm === 1 && ld === 2) return "春節";
        if (lm === 1 && ld === 3) return "春節";
        if (lm === 5 && ld === 5) return "端午節";
        if (lm === 8 && ld === 15) return "中秋節";

        // 除夕判定 (農曆最後一天)
        const nextDayLunar = lunar.getNextDay();
        if (nextDayLunar.getMonth() === 1 && nextDayLunar.getDay() === 1) return "除夕";

        // 清明節 (節氣判定)
        if (lunar.getJieQi() === "清明") return "民族掃墓節";

        return null;
    }

    const s2t_map = {
        '造庙': '造廟', '归宁': '歸寧', '入学': '入學', '坏垣': '壞垣', '求医': '求醫', '会亲友': '會親友', 
        '问名': '問名', '纳畜': '納畜', '牧养': '牧養', '补垣': '補垣', '开柱眼': '開柱眼', '断蚁': '斷蟻',
        '塑绘': '塑繪', '行丧': '行喪', '词讼': '詞訟', '置产': '置產', '入殓': '入殮', '開渠': '開渠', 
        '谢土': '謝土', '启钻': '啟鑽', '安机械': '安機械','造桥':'造橋', '诸事不宜': '諸事不宜', '诸事无忌': '諸事無忌', 
        '嫁娶': '嫁娶', '祭祀': '祭祀', '祈福': '祈福', '齋醮': '齋醮', '動土': '動土', '移徙': '移徙', '入宅': '入宅', 
        '修造': '修造', '安葬': '安葬', '立碑': '立碑', '修坟': '修墳', '成服': '成服', '除服': '除服', '納採': '納採', 
        '訂盟': '訂盟', '纳婿': '納婿', '安床': '安床', '開光': '開光', '經絡': '經絡', '解除': '解除', '豎柱': '豎柱', 
        '上梁': '上樑', '蓋屋': '蓋屋', '納財': '納財', '開市': '開市', '交易': '交易', '立券': '立券', '掛匾': '掛匾', 
        '出行': '出行', '理髮': '理髮', '安門': '安門', '修飾垣牆': '修飾垣牆', '造畜稠': '造畜稠', '作灶': '作灶', 
        '放水': '放水', '掘井': '掘井', '開池': '開池', '開廁': '開廁', '破土': '破土', '啟攢': '啟攢', '掃舍': '掃舍', 
        '平治道塗': '平治道塗', '餘事勿取': '餘事勿取', '求嗣': '求嗣', '伐木': '伐木', '畋獵': '畋獵', '捕捉': '捕捉', 
        '結網': '結網', '取漁': '取漁', '教牛馬': '教牛馬', '開生墳': '開生墳', '驚蟄': '驚蟄', '小滿': '小滿', '芒種': '芒種', 
        '處暑': '處暑', '白露': '白露', '寒露': '寒露', '霜降': '霜降', '開倉': '開倉', '出貨財': '出貨財', '臘月': '臘月',
        '沖': '沖', '煞': '煞', '東': '東', '西': '西', '南': '南', '北': '北', '正東': '正東', '正西': '正西', '正南': '正南', '正北': '正北',
        '龍': '龍', '馬': '馬', '雞': '雞', '豬': '豬', '屬': '屬'
    };

    function toTraditional(text) {
        if (!text) return "";
        if (Array.isArray(text)) return text.map(item => toTraditional(item));
        let newItem = String(text);
        for (let key in s2t_map) { newItem = newItem.replace(new RegExp(key, 'g'), s2t_map[key]); }
        return newItem;
    }

    let currentDate = new Date();

    function initPicker() {
        const yearSelect = document.getElementById('yearSelect');
        for (let y = 1900; y <= 2100; y++) {
            const opt = document.createElement('option');
            opt.value = y; opt.innerText = y;
            yearSelect.appendChild(opt);
        }
    }

    function onPickerChange() {
        currentDate = new Date(document.getElementById('yearSelect').value, document.getElementById('monthSelect').value, 1);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('yearSelect').value = year;
        document.getElementById('monthSelect').value = month;

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const container = document.getElementById('calendarDays');
        container.innerHTML = '';

        for (let i = 0; i < firstDay; i++) {
            container.innerHTML += `<div class="day-box border-transparent bg-gray-50"></div>`;
        }

        for (let d = 1; d <= lastDate; d++) {
            const dateObj = new Date(year, month, d);
            const solar = Solar.fromDate(dateObj);
            const lunar = solar.getLunar();
            const weekDay = dateObj.getDay();
            const holidayName = getTWOHoliday(solar, lunar);
            
            // 假日判定：自定義節慶 OR 週六 OR 週日
            const isHoliday = holidayName !== null || weekDay === 0 || weekDay === 6;
            const isToday = new Date().toDateString() === dateObj.toDateString();

            const dayHtml = `
                <div onclick="showDetail(${year}, ${month}, ${d}, this)" 
                     class="day-box flex flex-col items-center justify-center ${isHoliday ? 'bg-red-600 text-white' : 'bg-white text-gray-800'} ${isToday ? 'ring-2 ring-inset ring-black' : ''}">
                    <div class="text-3xl font-light serif leading-none">${d}</div>
                    <div class="absolute bottom-1 right-1 text-[8px] flex flex-col items-end leading-tight">
                        <span class="${isHoliday ? 'text-white' : 'text-gray-400'}">${toTraditional(lunar.getDayInChinese())}</span>
                    </div>
                </div>
            `;
            container.innerHTML += dayHtml;
        }

        const defaultDay = (new Date().getMonth() === month && new Date().getFullYear() === year) ? new Date().getDate() : 1;
        showDetail(year, month, defaultDay);
    }

    function showDetail(y, m, d, element) {
        document.querySelectorAll('.day-box').forEach(el => el.classList.remove('active-day'));
        if(element) element.classList.add('active-day');

        const date = new Date(y, m, d);
        const solar = Solar.fromDate(date);
        const lunar = solar.getLunar();
        const holidayName = getTWOHoliday(solar, lunar);
        const yiList = toTraditional(lunar.getDayYi());
        const jiList = toTraditional(lunar.getDayJi());

        document.getElementById('detailPanel').innerHTML = `
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-xs tracking-tighter text-gray-400 uppercase font-bold">${y}年${m+1}月${d}日</div>
                    <button onclick="copyInfo('${y}/${m+1}/${d} 農曆${toTraditional(lunar.getMonthInChinese())}月${toTraditional(lunar.getDayInChinese())} 宜:${yiList.join(',')} 忌:${jiList.join(',')}')" 
                            class="text-[10px] text-gray-400 border px-3 py-1 rounded-full active:bg-gray-100">複製資訊</button>
                </div>
                
                ${holidayName ? `<div class="festival-tag">慶 · ${holidayName}</div>` : ''}
                
                <div class="text-6xl font-light serif mb-4">${d}</div>
                
                <div class="space-y-1 border-b border-gray-100 pb-4 mb-6">
                    <div class="text-2xl font-bold serif">農曆 ${toTraditional(lunar.getMonthInChinese())}月${toTraditional(lunar.getDayInChinese())}</div>
                    <div class="text-gray-500 text-xs font-medium">
                        ${toTraditional(lunar.getYearInGanZhi())}(${toTraditional(lunar.getYearShengXiao())})年 · 
                        ${toTraditional(lunar.getMonthInGanZhi())}月 · 
                        ${toTraditional(lunar.getDayInGanZhi())}日
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <div class="text-2xl font-bold text-red-700 mb-2 tracking-widest">【宜】</div>
                        <div class="flex flex-wrap text-base font-medium text-red-600 gap-x-3 gap-y-2">
                            ${yiList.length > 0 ? yiList.map(item => `<span class="underline decoration-red-100 underline-offset-4">${item}</span>`).join('') : '諸事不宜'}
                        </div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-900 mb-2 tracking-widest">【忌】</div>
                        <div class="flex flex-wrap text-base font-medium text-black gap-x-3 gap-y-2">
                            ${jiList.length > 0 ? jiList.map(item => `<span class="underline decoration-gray-200 underline-offset-4">${item}</span>`).join('') : '諸事無忌'}
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-gray-100 text-[11px] text-gray-400 space-y-1 leading-relaxed">
                    <div>節氣：<span class="text-gray-600 font-medium">${toTraditional(lunar.getJieQi()) || '無'}</span></div>
                    <div>沖煞：<span class="text-gray-600 font-medium">${toTraditional(lunar.getDayChongDesc())}</span></div>
                    <div>五行：<span class="text-gray-600 font-medium">${toTraditional(lunar.getDayNaYin())}</span></div>
                </div>
            </div>
        `;
    }

    function copyInfo(text) {
        navigator.clipboard.writeText(text).then(() => {
            const tip = document.getElementById('copyTip');
            tip.style.opacity = '1';
            setTimeout(() => tip.style.opacity = '0', 2000);
        });
    }

    function changeMonth(offset) {
        currentDate.setMonth(currentDate.getMonth() + offset);
        renderCalendar();
    }

    function goToday() {
        currentDate = new Date();
        renderCalendar();
    }

    initPicker();
    renderCalendar();
</script>

</body>
</html>